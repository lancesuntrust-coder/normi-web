#!/bin/sh
. "$(dirname "$0")/husky.sh"

set -e

# Run lint-staged only when TS/TSX files are staged (skip for docs/asset-only commits)
STAGED_FILES=$(git diff --cached --name-only || true)
TS_OR_TSX=$(printf "%s\n" "$STAGED_FILES" | grep -E '^src/.*\.(ts|tsx)$' || true)
if [ -n "$TS_OR_TSX" ]; then
  echo "[husky] Running lint-staged on staged TS/TSX files..."
  npx lint-staged || {
    echo "[husky] lint-staged failed. Aborting commit." >&2
    exit 1
  }
else
  echo "[husky] Skipping lint-staged (no TS/TSX files staged)."
fi

# Prevent reintroducing duplicate component locations or barrels
# Fail if any files are added under src/components root that should be under ui/sections/layout
ADDED_FILES=$(git diff --cached --name-only --diff-filter=A || true)
echo "[husky] Added files:" "$ADDED_FILES"
if [ -n "$ADDED_FILES" ] && echo "$ADDED_FILES" | grep -E '^src/components/(BottomNavPill|Hero|HeroVisual|TopControls|Footer|ScenePreview)\\.tsx$' >/dev/null 2>&1; then
  echo "[husky] Error: Add components only under canonical folders (ui/, sections/, layout/)." >&2
  exit 1
fi

# Fail if a components barrel is reintroduced
if [ -n "$ADDED_FILES" ] && echo "$ADDED_FILES" | grep -E '^src/components/index\\.ts$' >/dev/null 2>&1; then
  echo "[husky] Error: Do not add barrels. Import canonical components directly." >&2
  exit 1
fi

# Enforce: No Tailwind utilities in TSX className
FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.tsx$' || true)
if [ -n "$FILES" ]; then
  echo "[husky] Checking TSX for Tailwind utilities in className..."
  BANNED='(flex|grid|items-|justify-|gap-|px-|py-|pt-|pb-|pl-|pr-|m-|w-|h-|min-|max-|text-|bg-|rounded-|absolute|relative|fixed|inset-|top-|left-|right-|bottom-|overflow-|backdrop-)'
  for f in $FILES; do
    if git show ":$f" | grep -nE "className\\s*=\\s*['\"]([^'\"]*${BANNED}[^'\"]*)" >/dev/null 2>&1; then
      echo "[husky] Error: Tailwind utility detected in $f. Move all utilities into component CSS and use semantic classes in TSX." >&2
      exit 1
    fi
  done
fi

echo "[husky] Tailwind-in-TSX check passed."

echo "[husky] Pre-commit checks passed."
